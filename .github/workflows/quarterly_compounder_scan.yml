name: Quarterly Compounder Scan

on:
  schedule:
    # Run quarterly: Jan 15, Apr 15, Jul 15, Oct 15
    - cron: '0 9 15 1 *'   # January 15 at 9 AM UTC
    - cron: '0 9 15 4 *'   # April 15 at 9 AM UTC
    - cron: '0 9 15 7 *'   # July 15 at 9 AM UTC
    - cron: '0 9 15 10 *'  # October 15 at 9 AM UTC

  # Allow manual trigger
  workflow_dispatch:

jobs:
  quarterly_scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git operations

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy yfinance requests python-dotenv

      - name: Configure git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Run quarterly compounder scan
        env:
          FMP_API_KEY: ${{ secrets.FMP_API_KEY }}
        run: |
          python run_quarterly_compounder_scan.py \
            --log-level INFO \
            --output-dir data/quarterly_reports
        timeout-minutes: 30

      - name: Generate report summary
        if: success()
        run: |
          echo "## Quarterly Compounder Scan Complete ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Generated Files" >> $GITHUB_STEP_SUMMARY
          ls -lh data/quarterly_reports/allocation_model_*.csv 2>/dev/null | awk '{print "- " $9}' >> $GITHUB_STEP_SUMMARY || echo "- CSV files pending" >> $GITHUB_STEP_SUMMARY

      - name: Commit reports to git
        if: success()
        run: |
          # Check if there are changes
          if [ -n "$(git status --porcelain data/quarterly_reports/)" ]; then
            git add data/quarterly_reports/

            # Get quarter designation
            MONTH=$(date +%m)
            YEAR=$(date +%Y)
            Q=$(( (MONTH - 1) / 3 + 1 ))

            git commit -m "chore: Quarterly compounder scan results Q${Q} ${YEAR}

            - Scored top 500 stocks with compounder engine
            - Identified top 25 individual compounders
            - Scored and selected top 10 thematic ETFs
            - Built optimal portfolio with concentration rules
            - Generated quarterly ownership reports
            - Calculated rebalance actions

            Automated by GitHub Actions quarterly_compounder_scan workflow.
            "
            git push
          else
            echo "No changes to commit"
          fi

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '❌ Quarterly Compounder Scan Failed',
              body: `The quarterly compounder scan failed on ${new Date().toISOString()}

              **Workflow Run:** [${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

              Please review logs and fix any issues.
              `,
              labels: ['automated', 'scan-failure']
            })

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: quarterly-reports
          path: data/quarterly_reports/
          retention-days: 90

  notify:
    runs-on: ubuntu-latest
    needs: quarterly_scan
    if: always()

    steps:
      - name: Send success notification
        if: needs.quarterly_scan.result == 'success'
        run: |
          echo "✅ Quarterly compounder scan completed successfully"

      - name: Send failure notification
        if: needs.quarterly_scan.result == 'failure'
        run: |
          echo "❌ Quarterly compounder scan failed - check logs"
          exit 1
